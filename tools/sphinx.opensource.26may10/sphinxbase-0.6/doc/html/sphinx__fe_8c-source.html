<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>SphinxBase: src/sphinx_fe/sphinx_fe.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
<h1>src/sphinx_fe/sphinx_fe.c</h1><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/* -*- c-basic-offset: 4; indent-tabs-mode: nil -*- */</span>
<a name="l00002"></a>00002 <span class="comment">/* ====================================================================</span>
<a name="l00003"></a>00003 <span class="comment"> * Copyright (c) 1996-2004 Carnegie Mellon University.  All rights </span>
<a name="l00004"></a>00004 <span class="comment"> * reserved.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
<a name="l00007"></a>00007 <span class="comment"> * modification, are permitted provided that the following conditions</span>
<a name="l00008"></a>00008 <span class="comment"> * are met:</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
<a name="l00011"></a>00011 <span class="comment"> *    notice, this list of conditions and the following disclaimer. </span>
<a name="l00012"></a>00012 <span class="comment"> *</span>
<a name="l00013"></a>00013 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
<a name="l00014"></a>00014 <span class="comment"> *    notice, this list of conditions and the following disclaimer in</span>
<a name="l00015"></a>00015 <span class="comment"> *    the documentation and/or other materials provided with the</span>
<a name="l00016"></a>00016 <span class="comment"> *    distribution.</span>
<a name="l00017"></a>00017 <span class="comment"> *</span>
<a name="l00018"></a>00018 <span class="comment"> * This work was supported in part by funding from the Defense Advanced </span>
<a name="l00019"></a>00019 <span class="comment"> * Research Projects Agency and the National Science Foundation of the </span>
<a name="l00020"></a>00020 <span class="comment"> * United States of America, and the CMU Sphinx Speech Consortium.</span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY CARNEGIE MELLON UNIVERSITY ``AS IS'' AND </span>
<a name="l00023"></a>00023 <span class="comment"> * ANY EXPRESSED OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, </span>
<a name="l00024"></a>00024 <span class="comment"> * THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR</span>
<a name="l00025"></a>00025 <span class="comment"> * PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL CARNEGIE MELLON UNIVERSITY</span>
<a name="l00026"></a>00026 <span class="comment"> * NOR ITS EMPLOYEES BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<a name="l00027"></a>00027 <span class="comment"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT </span>
<a name="l00028"></a>00028 <span class="comment"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, </span>
<a name="l00029"></a>00029 <span class="comment"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY </span>
<a name="l00030"></a>00030 <span class="comment"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT </span>
<a name="l00031"></a>00031 <span class="comment"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE </span>
<a name="l00032"></a>00032 <span class="comment"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> * ====================================================================</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> */</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;stdlib.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="preprocessor">#ifdef HAVE_CONFIG_H</span>
<a name="l00044"></a>00044 <span class="preprocessor"></span><span class="preprocessor">#include &lt;config.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#endif</span>
<a name="l00046"></a>00046 <span class="preprocessor"></span>
<a name="l00047"></a>00047 <span class="preprocessor">#include "fe.h"</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include "<a class="code" href="strfuncs_8h.html" title="Miscellaneous useful string functions.">strfuncs.h</a>"</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include "<a class="code" href="pio_8h.html" title="file IO related operations.">pio.h</a>"</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include "<a class="code" href="filename_8h.html" title="File names related operation.">filename.h</a>"</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include "<a class="code" href="cmd__ln_8h.html" title="Command-line and other configurationparsing and handling.">cmd_ln.h</a>"</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include "<a class="code" href="err_8h.html" title="Implementation of logging routines.">err.h</a>"</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include "<a class="code" href="ckd__alloc_8h.html" title="Sphinx&amp;#39;s memory allocation/deallocation routines.">ckd_alloc.h</a>"</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include "byteorder.h"</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <span class="preprocessor">#include "sphinx_wave2feat.h"</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include "cmd_ln_defn.h"</span>
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="keyword">typedef</span> <span class="keyword">struct </span>audio_type_s {
<a name="l00060"></a>00060     <span class="keywordtype">char</span> <span class="keyword">const</span> *name;
<a name="l00061"></a>00061     int (*detect)(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile);
<a name="l00062"></a>00062     int (*decode)(sphinx_wave2feat_t *wtf);
<a name="l00063"></a>00063 } audio_type_t;
<a name="l00064"></a>00064 
<a name="l00065"></a>00065 <span class="keyword">typedef</span> <span class="keyword">struct </span>output_type_s {
<a name="l00066"></a>00066     <span class="keywordtype">char</span> <span class="keyword">const</span> *name;
<a name="l00067"></a>00067     int (*output_header)(sphinx_wave2feat_t *wtf, <span class="keywordtype">int</span> nfloat);
<a name="l00068"></a>00068     int (*output_frames)(sphinx_wave2feat_t *wtf, mfcc_t **frames, <span class="keywordtype">int</span> nfr);
<a name="l00069"></a>00069 } output_type_t;
<a name="l00070"></a>00070 
<a name="l00071"></a>00071 <span class="keyword">struct </span>sphinx_wave2feat_s {
<a name="l00072"></a>00072     <span class="keywordtype">int</span> refcount;     
<a name="l00073"></a>00073     <a class="code" href="structcmd__ln__t.html" title="Opaque structure used to hold the results of command-line parsing.">cmd_ln_t</a> *config; 
<a name="l00074"></a>00074     <a class="code" href="structfe__s.html" title="Structure for the front-end computation.">fe_t</a> *fe;         
<a name="l00075"></a>00075     <span class="keywordtype">char</span> *infile;     
<a name="l00076"></a>00076     <span class="keywordtype">char</span> *outfile;    
<a name="l00077"></a>00077     FILE *infh;       
<a name="l00078"></a>00078     FILE *outfh;      
<a name="l00079"></a>00079     <span class="keywordtype">short</span> *audio;     
<a name="l00080"></a>00080     mfcc_t **feat;    
<a name="l00081"></a>00081     <span class="keywordtype">int</span> blocksize;    
<a name="l00082"></a>00082     <span class="keywordtype">int</span> featsize;     
<a name="l00083"></a>00083     <span class="keywordtype">int</span> veclen;       
<a name="l00084"></a>00084     <span class="keywordtype">int</span> in_veclen;    
<a name="l00085"></a>00085     <span class="keywordtype">int</span> byteswap;     
<a name="l00086"></a>00086     output_type_t <span class="keyword">const</span> *ot;
<a name="l00087"></a>00087 };
<a name="l00088"></a>00088 
<a name="l00090"></a><a class="code" href="structRIFFHeader.html">00090</a> <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structRIFFHeader.html" title="RIFF 44-byte header structure for MS wav files.">RIFFHeader</a>{
<a name="l00091"></a>00091     <span class="keywordtype">char</span> rifftag[4];      <span class="comment">/* "RIFF" string */</span>
<a name="l00092"></a>00092     int32 TotalLength;      <span class="comment">/* Total length */</span>
<a name="l00093"></a>00093     <span class="keywordtype">char</span> wavefmttag[8];   <span class="comment">/* "WAVEfmt " string (note space after 't') */</span>
<a name="l00094"></a>00094     int32 RemainingLength;  <span class="comment">/* Remaining length */</span>
<a name="l00095"></a>00095     int16 data_format;    <span class="comment">/* data format tag, 1 = PCM */</span>
<a name="l00096"></a>00096     int16 numchannels;    <span class="comment">/* Number of channels in file */</span>
<a name="l00097"></a>00097     int32 SamplingFreq;     <span class="comment">/* Sampling frequency */</span>
<a name="l00098"></a>00098     int32 BytesPerSec;      <span class="comment">/* Average bytes/sec */</span>
<a name="l00099"></a>00099     int16 BlockAlign;     <span class="comment">/* Block align */</span>
<a name="l00100"></a>00100     int16 BitsPerSample;  <span class="comment">/* 8 or 16 bit */</span>
<a name="l00101"></a>00101     <span class="keywordtype">char</span> datatag[4];      <span class="comment">/* "data" string */</span>
<a name="l00102"></a>00102     int32 datalength;       <span class="comment">/* Raw data length */</span>
<a name="l00103"></a>00103 } <a class="code" href="structRIFFHeader.html" title="RIFF 44-byte header structure for MS wav files.">MSWAV_hdr</a>;
<a name="l00104"></a>00104 
<a name="l00110"></a>00110 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00111"></a>00111 detect_riff(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile)
<a name="l00112"></a>00112 {
<a name="l00113"></a>00113     FILE *fh;
<a name="l00114"></a>00114     <a class="code" href="structRIFFHeader.html" title="RIFF 44-byte header structure for MS wav files.">MSWAV_hdr</a> hdr;
<a name="l00115"></a>00115 
<a name="l00116"></a>00116     <span class="keywordflow">if</span> ((fh = fopen(infile, <span class="stringliteral">"rb"</span>)) == NULL) {
<a name="l00117"></a>00117         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open %s"</span>, infile);
<a name="l00118"></a>00118         <span class="keywordflow">return</span> -1;
<a name="l00119"></a>00119     }
<a name="l00120"></a>00120     <span class="keywordflow">if</span> (fread(&amp;hdr, <span class="keyword">sizeof</span>(hdr), 1, fh) != 1) {
<a name="l00121"></a>00121         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to read RIFF header"</span>);
<a name="l00122"></a>00122         fclose(fh);
<a name="l00123"></a>00123         <span class="keywordflow">return</span> -1;
<a name="l00124"></a>00124     }
<a name="l00125"></a>00125     <span class="comment">/* Make sure it is actually a RIFF file. */</span>
<a name="l00126"></a>00126     <span class="keywordflow">if</span> (0 != memcmp(hdr.<a class="code" href="structRIFFHeader.html#41ad222f7a391957baebb72b520ca313">rifftag</a>, <span class="stringliteral">"RIFF"</span>, 4))
<a name="l00127"></a>00127         <span class="keywordflow">return</span> FALSE;
<a name="l00128"></a>00128 
<a name="l00129"></a>00129     <span class="comment">/* Get relevant information. */</span>
<a name="l00130"></a>00130     cmd_ln_set_int32_r(wtf-&gt;config, <span class="stringliteral">"-nchans"</span>, hdr.<a class="code" href="structRIFFHeader.html#b639e289d0009f82f7860edd8e324daf">numchannels</a>);
<a name="l00131"></a>00131     cmd_ln_set_float32_r(wtf-&gt;config, <span class="stringliteral">"-samprate"</span>, hdr.<a class="code" href="structRIFFHeader.html#7723e76cc1ff383b0f4f7a053f43d31f">SamplingFreq</a>);
<a name="l00132"></a>00132     wtf-&gt;infile = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(infile);
<a name="l00133"></a>00133     wtf-&gt;infh = fh;
<a name="l00134"></a>00134 
<a name="l00135"></a>00135     <span class="keywordflow">return</span> TRUE;
<a name="l00136"></a>00136 }
<a name="l00137"></a>00137 
<a name="l00143"></a>00143 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00144"></a>00144 detect_nist(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146     <span class="keywordtype">char</span> nist[7];
<a name="l00147"></a>00147     <a class="code" href="structlineiter__t.html" title="Line iterator for files.">lineiter_t</a> *li;
<a name="l00148"></a>00148     FILE *fh;
<a name="l00149"></a>00149 
<a name="l00150"></a>00150     <span class="keywordflow">if</span> ((fh = fopen(infile, <span class="stringliteral">"rb"</span>)) == NULL) {
<a name="l00151"></a>00151         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open %s"</span>, infile);
<a name="l00152"></a>00152         <span class="keywordflow">return</span> -1;
<a name="l00153"></a>00153     }
<a name="l00154"></a>00154     <span class="keywordflow">if</span> (fread(&amp;nist, 1, 7, fh) != 7) {
<a name="l00155"></a>00155         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to read NIST header"</span>);
<a name="l00156"></a>00156         fclose(fh);
<a name="l00157"></a>00157         <span class="keywordflow">return</span> -1;
<a name="l00158"></a>00158     }
<a name="l00159"></a>00159     <span class="comment">/* Is this actually a NIST file? */</span>
<a name="l00160"></a>00160     <span class="keywordflow">if</span> (0 != strncmp(nist, <span class="stringliteral">"NIST_1A"</span>, 7)) {
<a name="l00161"></a>00161         fclose(fh);
<a name="l00162"></a>00162         <span class="keywordflow">return</span> FALSE;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     <span class="comment">/* Rewind, parse lines. */</span>
<a name="l00165"></a>00165     fseek(fh, 0, SEEK_SET);
<a name="l00166"></a>00166     <span class="keywordflow">for</span> (li = <a class="code" href="pio_8h.html#22d0125ab198f02f8bbe543417d99566" title="Start reading lines from a file.">lineiter_start</a>(fh); li; li = <a class="code" href="pio_8h.html#ff8df0b6928746d61b3520555263f71e" title="Move to the next line in the file.">lineiter_next</a>(li)) {
<a name="l00167"></a>00167         <span class="keywordtype">char</span> **words;
<a name="l00168"></a>00168         <span class="keywordtype">int</span> nword;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170         <a class="code" href="strfuncs_8h.html#c36a095632a4f16cf4e0fbcdb01de5ad" title="Remove whitespace from a string, modifying it in-place.">string_trim</a>(li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>, <a class="code" href="strfuncs_8h.html#b5c9ca15770a4bd3047705762b815df94fcbb0fe16fa4aa48723ba3ba10c26dd" title="Both ends of string.">STRING_BOTH</a>);
<a name="l00171"></a>00171         <span class="keywordflow">if</span> (strlen(li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>) == 0)
<a name="l00172"></a>00172             <span class="keywordflow">break</span>;
<a name="l00173"></a>00173         nword = <a class="code" href="strfuncs_8h.html#5b520fdebcca599db86faaf75a82173f" title="Convert a line to an array of &amp;quot;words&amp;quot;, based on whitespace separators.">str2words</a>(li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>, NULL, 0);
<a name="l00174"></a>00174         <span class="keywordflow">if</span> (nword != 3)
<a name="l00175"></a>00175             <span class="keywordflow">continue</span>;
<a name="l00176"></a>00176         words = <a class="code" href="ckd__alloc_8h.html#a00ef21903bc4f8a972488417adc8d2e" title="Macros to simplify the use of above functions.">ckd_calloc</a>(nword, <span class="keyword">sizeof</span>(*words));
<a name="l00177"></a>00177         <a class="code" href="strfuncs_8h.html#5b520fdebcca599db86faaf75a82173f" title="Convert a line to an array of &amp;quot;words&amp;quot;, based on whitespace separators.">str2words</a>(li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>, words, nword);
<a name="l00178"></a>00178         <span class="keywordflow">if</span> (0 == strcmp(words[0], <span class="stringliteral">"sample_rate"</span>)) {
<a name="l00179"></a>00179             cmd_ln_set_float32_r(wtf-&gt;config, <span class="stringliteral">"-samprate"</span>, <a class="code" href="strfuncs_8h.html#b708351fe7308551632a782bfad75a1e" title="Locale independent version of atof().">atof_c</a>(words[2]));
<a name="l00180"></a>00180         }
<a name="l00181"></a>00181         <span class="keywordflow">if</span> (0 == strcmp(words[0], <span class="stringliteral">"channel_count"</span>)) {
<a name="l00182"></a>00182             cmd_ln_set_float32_r(wtf-&gt;config, <span class="stringliteral">"-nchans"</span>, atoi(words[2]));
<a name="l00183"></a>00183         }
<a name="l00184"></a>00184         <span class="keywordflow">if</span> (0 == strcmp(words[0], <span class="stringliteral">"sample_byte_format"</span>)) {
<a name="l00185"></a>00185             <a class="code" href="cmd__ln_8h.html#3868b219fd3eaf64e902db38145c1c59" title="Set a string in a command-line object.">cmd_ln_set_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-input_endian"</span>,
<a name="l00186"></a>00186                              (0 == strcmp(words[2], <span class="stringliteral">"10"</span>)) ? <span class="stringliteral">"big"</span> : <span class="stringliteral">"little"</span>);
<a name="l00187"></a>00187         }
<a name="l00188"></a>00188         <span class="comment">/* FIMXE: Warn about shorten-compressed data. */</span>
<a name="l00189"></a>00189         <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(words);
<a name="l00190"></a>00190     }
<a name="l00191"></a>00191     fseek(fh, 1024, SEEK_SET);
<a name="l00192"></a>00192     wtf-&gt;infile = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(infile);
<a name="l00193"></a>00193     wtf-&gt;infh = fh;
<a name="l00194"></a>00194     <span class="keywordflow">return</span> TRUE;
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a>00197 
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00205"></a>00205 detect_raw(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile)
<a name="l00206"></a>00206 {
<a name="l00207"></a>00207     FILE *fh;
<a name="l00208"></a>00208 
<a name="l00209"></a>00209     <span class="keywordflow">if</span> ((fh = fopen(infile, <span class="stringliteral">"rb"</span>)) == NULL) {
<a name="l00210"></a>00210         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open %s"</span>, infile);
<a name="l00211"></a>00211         <span class="keywordflow">return</span> -1;
<a name="l00212"></a>00212     }
<a name="l00213"></a>00213     wtf-&gt;infile = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(infile);
<a name="l00214"></a>00214     wtf-&gt;infh = fh;
<a name="l00215"></a>00215     <span class="keywordflow">return</span> TRUE;
<a name="l00216"></a>00216 }
<a name="l00217"></a>00217 
<a name="l00224"></a>00224 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00225"></a>00225 detect_sphinx_mfc(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile)
<a name="l00226"></a>00226 {
<a name="l00227"></a>00227     FILE *fh;
<a name="l00228"></a>00228     int32 len;
<a name="l00229"></a>00229     <span class="keywordtype">long</span> flen;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231     <span class="keywordflow">if</span> ((fh = fopen(infile, <span class="stringliteral">"rb"</span>)) == NULL) {
<a name="l00232"></a>00232         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open %s"</span>, infile);
<a name="l00233"></a>00233         <span class="keywordflow">return</span> -1;
<a name="l00234"></a>00234     }
<a name="l00235"></a>00235     <span class="keywordflow">if</span> (fread(&amp;len, 4, 1, fh) != 1) {
<a name="l00236"></a>00236         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to read header from %s\n"</span>, infile);
<a name="l00237"></a>00237         <span class="keywordflow">return</span> -1;
<a name="l00238"></a>00238     }
<a name="l00239"></a>00239     fseek(fh, 0, SEEK_END);
<a name="l00240"></a>00240     flen = ftell(fh);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242     <span class="comment">/* figure out whether to byteswap */</span>
<a name="l00243"></a>00243     flen = (flen / 4) - 1;
<a name="l00244"></a>00244     <span class="keywordflow">if</span> (flen != len) {
<a name="l00245"></a>00245         <span class="comment">/* First make sure this is an endianness problem, otherwise fail. */</span>
<a name="l00246"></a>00246         SWAP_INT32(&amp;len);
<a name="l00247"></a>00247         <span class="keywordflow">if</span> (flen != len) {
<a name="l00248"></a>00248             SWAP_INT32(&amp;len);
<a name="l00249"></a>00249             <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Mismatch in header/file lengths: 0x%08x vs 0x%08x\n"</span>,
<a name="l00250"></a>00250                     len, flen);
<a name="l00251"></a>00251             <span class="keywordflow">return</span> -1;
<a name="l00252"></a>00252         }
<a name="l00253"></a>00253         <span class="comment">/* Set the input endianness to the opposite of the machine endianness... */</span>
<a name="l00254"></a>00254         <a class="code" href="cmd__ln_8h.html#3868b219fd3eaf64e902db38145c1c59" title="Set a string in a command-line object.">cmd_ln_set_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-input_endian"</span>,
<a name="l00255"></a>00255                          (0 == strcmp(<span class="stringliteral">"big"</span>, <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-mach_endian"</span>))
<a name="l00256"></a>00256                           ? <span class="stringliteral">"little"</span> : <span class="stringliteral">"big"</span>));
<a name="l00257"></a>00257     }
<a name="l00258"></a>00258     
<a name="l00259"></a>00259     fseek(fh, 4, SEEK_SET);
<a name="l00260"></a>00260     wtf-&gt;infile = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(infile);
<a name="l00261"></a>00261     wtf-&gt;infh = fh;
<a name="l00262"></a>00262     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-spec2cep"</span>)) {
<a name="l00263"></a>00263         wtf-&gt;in_veclen = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-nfilt"</span>);
<a name="l00264"></a>00264     }
<a name="l00265"></a>00265     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-cep2spec"</span>)) {
<a name="l00266"></a>00266         wtf-&gt;in_veclen = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-ncep"</span>);
<a name="l00267"></a>00267         wtf-&gt;veclen = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-nfilt"</span>);
<a name="l00268"></a>00268     }
<a name="l00269"></a>00269     <span class="keywordflow">else</span> {
<a name="l00270"></a>00270         <span class="comment">/* Should not happen. */</span>
<a name="l00271"></a>00271         <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Sphinx MFCC file reading requested but -spec2cep/-cep2spec not given\n"</span>);
<a name="l00272"></a>00272         assert(FALSE);
<a name="l00273"></a>00273     }
<a name="l00274"></a>00274             
<a name="l00275"></a>00275     <span class="keywordflow">return</span> TRUE;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 
<a name="l00282"></a>00282 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00283"></a>00283 decode_pcm(sphinx_wave2feat_t *wtf)
<a name="l00284"></a>00284 {
<a name="l00285"></a>00285     <span class="keywordtype">size_t</span> nsamp;
<a name="l00286"></a>00286     int32 nfr;
<a name="l00287"></a>00287     <span class="keywordtype">int</span> nfloat, n;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289     fe_start_utt(wtf-&gt;fe);
<a name="l00290"></a>00290     nfloat = 0;
<a name="l00291"></a>00291     <span class="keywordflow">while</span> ((nsamp = fread(wtf-&gt;audio, 2, wtf-&gt;blocksize, wtf-&gt;infh)) != 0) {
<a name="l00292"></a>00292         <span class="keywordtype">size_t</span> nvec;
<a name="l00293"></a>00293         int16 <span class="keyword">const</span> *inspeech;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295         <span class="comment">/* Byteswap stuff here if necessary. */</span>
<a name="l00296"></a>00296         <span class="keywordflow">if</span> (wtf-&gt;byteswap) {
<a name="l00297"></a>00297             <span class="keywordflow">for</span> (n = 0; n &lt; nsamp; ++n)
<a name="l00298"></a>00298                 SWAP_INT16(wtf-&gt;audio + n);
<a name="l00299"></a>00299         }
<a name="l00300"></a>00300             
<a name="l00301"></a>00301         inspeech = wtf-&gt;audio;
<a name="l00302"></a>00302         nvec = wtf-&gt;featsize;
<a name="l00303"></a>00303         <span class="comment">/* Consume all samples. */</span>
<a name="l00304"></a>00304         <span class="keywordflow">while</span> (nsamp) {
<a name="l00305"></a>00305             nfr = nvec;
<a name="l00306"></a>00306             fe_process_frames(wtf-&gt;fe, &amp;inspeech, &amp;nsamp, wtf-&gt;feat, &amp;nfr);
<a name="l00307"></a>00307             <span class="keywordflow">if</span> (nfr) {
<a name="l00308"></a>00308                 <span class="keywordflow">if</span> ((n = (*wtf-&gt;ot-&gt;output_frames)(wtf, wtf-&gt;feat, nfr)) &lt; 0)
<a name="l00309"></a>00309                     <span class="keywordflow">return</span> -1;
<a name="l00310"></a>00310                 nfloat += n;
<a name="l00311"></a>00311             }
<a name="l00312"></a>00312         }
<a name="l00313"></a>00313         inspeech = wtf-&gt;audio;
<a name="l00314"></a>00314     }
<a name="l00315"></a>00315     <span class="comment">/* Now process any leftover audio frames. */</span>
<a name="l00316"></a>00316     fe_end_utt(wtf-&gt;fe, wtf-&gt;feat[0], &amp;nfr);
<a name="l00317"></a>00317     <span class="keywordflow">if</span> (nfr) {
<a name="l00318"></a>00318         <span class="keywordflow">if</span> ((n = (*wtf-&gt;ot-&gt;output_frames)(wtf, wtf-&gt;feat, nfr)) &lt; 0)
<a name="l00319"></a>00319             <span class="keywordflow">return</span> -1;
<a name="l00320"></a>00320         nfloat += n;
<a name="l00321"></a>00321     }
<a name="l00322"></a>00322 
<a name="l00323"></a>00323     fclose(wtf-&gt;infh);
<a name="l00324"></a>00324     wtf-&gt;infh = NULL;
<a name="l00325"></a>00325     <span class="keywordflow">return</span> nfloat;
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00332"></a>00332 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00333"></a>00333 decode_sphinx_mfc(sphinx_wave2feat_t *wtf)
<a name="l00334"></a>00334 {
<a name="l00335"></a>00335     <span class="keywordtype">int</span> nfloat = 0, n;
<a name="l00336"></a>00336     <span class="keywordtype">int</span> featsize = wtf-&gt;featsize;
<a name="l00337"></a>00337 
<a name="l00338"></a>00338     <span class="comment">/* If the input vector length is less than the output length, we</span>
<a name="l00339"></a>00339 <span class="comment">     * need to do this one frame at a time, because there's empty</span>
<a name="l00340"></a>00340 <span class="comment">     * space at the end of each vector in wtf-&gt;feat. */</span>
<a name="l00341"></a>00341     <span class="keywordflow">if</span> (wtf-&gt;in_veclen &lt; wtf-&gt;veclen)
<a name="l00342"></a>00342         featsize = 1;
<a name="l00343"></a>00343     <span class="keywordflow">while</span> ((n = fread(wtf-&gt;feat[0], <span class="keyword">sizeof</span>(**wtf-&gt;feat),
<a name="l00344"></a>00344                       featsize * wtf-&gt;in_veclen, wtf-&gt;infh)) != 0) {
<a name="l00345"></a>00345         <span class="keywordtype">int</span> i, nfr = n / wtf-&gt;in_veclen;
<a name="l00346"></a>00346         <span class="keywordflow">if</span> (n % wtf-&gt;in_veclen) {
<a name="l00347"></a>00347             <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Size of file %d not a multiple of veclen %d\n"</span>,
<a name="l00348"></a>00348                     n, wtf-&gt;in_veclen);
<a name="l00349"></a>00349             <span class="keywordflow">return</span> -1;
<a name="l00350"></a>00350         }
<a name="l00351"></a>00351         <span class="comment">/* Byteswap stuff here if necessary. */</span>
<a name="l00352"></a>00352         <span class="keywordflow">if</span> (wtf-&gt;byteswap) {
<a name="l00353"></a>00353             <span class="keywordflow">for</span> (i = 0; i &lt; n; ++i)
<a name="l00354"></a>00354                 SWAP_FLOAT32(wtf-&gt;feat[0] + i);
<a name="l00355"></a>00355         }
<a name="l00356"></a>00356         fe_float_to_mfcc(wtf-&gt;fe, (float32 **)wtf-&gt;feat, wtf-&gt;feat, nfr);
<a name="l00357"></a>00357         <span class="keywordflow">for</span> (i = 0; i &lt; nfr; ++i) {
<a name="l00358"></a>00358             <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-spec2cep"</span>)) {
<a name="l00359"></a>00359                 <span class="keywordflow">if</span> (0 == strcmp(<a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-transform"</span>), <span class="stringliteral">"legacy"</span>))
<a name="l00360"></a>00360                     fe_logspec_to_mfcc(wtf-&gt;fe, wtf-&gt;feat[i], wtf-&gt;feat[i]);
<a name="l00361"></a>00361                 <span class="keywordflow">else</span>
<a name="l00362"></a>00362                     fe_logspec_dct2(wtf-&gt;fe, wtf-&gt;feat[i], wtf-&gt;feat[i]);
<a name="l00363"></a>00363             }
<a name="l00364"></a>00364             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-cep2spec"</span>)) {
<a name="l00365"></a>00365                 fe_mfcc_dct3(wtf-&gt;fe, wtf-&gt;feat[i], wtf-&gt;feat[i]);
<a name="l00366"></a>00366             }
<a name="l00367"></a>00367         }
<a name="l00368"></a>00368         <span class="keywordflow">if</span> ((n = (*wtf-&gt;ot-&gt;output_frames)(wtf, wtf-&gt;feat, nfr)) &lt; 0)
<a name="l00369"></a>00369             <span class="keywordflow">return</span> -1;
<a name="l00370"></a>00370         nfloat += n;
<a name="l00371"></a>00371     }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     fclose(wtf-&gt;infh);
<a name="l00374"></a>00374     wtf-&gt;infh = NULL;
<a name="l00375"></a>00375     <span class="keywordflow">return</span> nfloat;
<a name="l00376"></a>00376 }
<a name="l00377"></a>00377 
<a name="l00378"></a>00378 <span class="keyword">static</span> <span class="keyword">const</span> audio_type_t types[] = {
<a name="l00379"></a>00379     { <span class="stringliteral">"-mswav"</span>, &amp;detect_riff, &amp;decode_pcm },
<a name="l00380"></a>00380     { <span class="stringliteral">"-nist"</span>, &amp;detect_nist, &amp;decode_pcm },
<a name="l00381"></a>00381 <span class="preprocessor">#ifdef HAVE_SNDFILE</span>
<a name="l00382"></a>00382 <span class="preprocessor"></span>    { <span class="stringliteral">"-sndfile"</span>, &amp;detect_sndfile, &amp;decode_sndfile },
<a name="l00383"></a>00383 <span class="preprocessor">#endif</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>    { <span class="stringliteral">"-raw"</span>, &amp;detect_raw, &amp;decode_pcm }
<a name="l00385"></a>00385 };
<a name="l00386"></a>00386 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> ntypes = <span class="keyword">sizeof</span>(types)/<span class="keyword">sizeof</span>(types[0]);
<a name="l00387"></a>00387 <span class="keyword">static</span> <span class="keyword">const</span> audio_type_t mfcc_type = {
<a name="l00388"></a>00388     <span class="stringliteral">"sphinx_mfc"</span>, &amp;detect_sphinx_mfc, &amp;decode_sphinx_mfc
<a name="l00389"></a>00389 };
<a name="l00390"></a>00390 
<a name="l00396"></a>00396 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00397"></a>00397 output_header_sphinx(sphinx_wave2feat_t *wtf, int32 nfloat)
<a name="l00398"></a>00398 {
<a name="l00399"></a>00399     <span class="keywordflow">if</span> (fwrite(&amp;nfloat, 4, 1, wtf-&gt;outfh) != 1) {
<a name="l00400"></a>00400         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to write to %s"</span>, wtf-&gt;outfile);
<a name="l00401"></a>00401         <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402     }
<a name="l00403"></a>00403     <span class="keywordflow">return</span> 0;
<a name="l00404"></a>00404 }
<a name="l00405"></a>00405 
<a name="l00411"></a>00411 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00412"></a>00412 output_frames_sphinx(sphinx_wave2feat_t *wtf, mfcc_t **frames, <span class="keywordtype">int</span> nfr)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414     <span class="keywordtype">int</span> i, nfloat = 0;
<a name="l00415"></a>00415 
<a name="l00416"></a>00416     fe_mfcc_to_float(wtf-&gt;fe, frames, (float32 **)frames, nfr);
<a name="l00417"></a>00417     <span class="keywordflow">for</span> (i = 0; i &lt; nfr; ++i) {
<a name="l00418"></a>00418         <span class="keywordflow">if</span> (fwrite(frames[i], <span class="keyword">sizeof</span>(float32), wtf-&gt;veclen, wtf-&gt;outfh) != wtf-&gt;veclen) {
<a name="l00419"></a>00419             <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Writing %d values to %s failed"</span>,
<a name="l00420"></a>00420                            wtf-&gt;veclen, wtf-&gt;outfile);
<a name="l00421"></a>00421             <span class="keywordflow">return</span> -1;
<a name="l00422"></a>00422         }
<a name="l00423"></a>00423         nfloat += wtf-&gt;veclen;
<a name="l00424"></a>00424     }
<a name="l00425"></a>00425     <span class="keywordflow">return</span> nfloat;
<a name="l00426"></a>00426 }
<a name="l00427"></a>00427 
<a name="l00428"></a>00428 <span class="keyword">typedef</span> <span class="keyword">enum</span> htk_feature_kind_e {
<a name="l00429"></a>00429     WAVEFORM = 0,   <span class="comment">/* PCM audio (rarely used) */</span>
<a name="l00430"></a>00430     LPC = 1,        <span class="comment">/* LPC filter coefficients */</span>
<a name="l00431"></a>00431     LPCREFC = 2,    <span class="comment">/* LPC reflection coefficients */</span>
<a name="l00432"></a>00432     LPCEPSTRA = 3,  <span class="comment">/* LPC-based cepstral coefficients */</span>
<a name="l00433"></a>00433     LPCDELCEP = 4,  <span class="comment">/* LPCC plus deltas */</span>
<a name="l00434"></a>00434     IREFC = 5,      <span class="comment">/* 16-bit integer LPC reflection coefficients */</span>
<a name="l00435"></a>00435     MFCC = 6,       <span class="comment">/* MFCCs */</span>
<a name="l00436"></a>00436     FBANK = 7,      <span class="comment">/* Log mel spectrum */</span>
<a name="l00437"></a>00437     MELSPEC = 8,    <span class="comment">/* Linear mel spectrum */</span>
<a name="l00438"></a>00438     USER = 9,       <span class="comment">/* User defined */</span>
<a name="l00439"></a>00439     DISCRETE = 10,  <span class="comment">/* Vector quantized data */</span>
<a name="l00440"></a>00440     PLP = 11        <span class="comment">/* PLP coefficients */</span>
<a name="l00441"></a>00441 } htk_feature_kind_t;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443 <span class="keyword">typedef</span> <span class="keyword">enum</span> htk_feature_flag_e {
<a name="l00444"></a>00444     _E = 0000100, <span class="comment">/* has energy */</span>
<a name="l00445"></a>00445     _N = 0000200, <span class="comment">/* absolute energy supressed */</span>
<a name="l00446"></a>00446     _D = 0000400, <span class="comment">/* has delta coefficients */</span>
<a name="l00447"></a>00447     _A = 0001000, <span class="comment">/* has acceleration (delta-delta) coefficients */</span>
<a name="l00448"></a>00448     _C = 0002000, <span class="comment">/* is compressed */</span>
<a name="l00449"></a>00449     _Z = 0004000, <span class="comment">/* has zero mean static coefficients (i.e. CMN) */</span>
<a name="l00450"></a>00450     _K = 0010000, <span class="comment">/* has CRC checksum */</span>
<a name="l00451"></a>00451     _O = 0020000, <span class="comment">/* has 0th cepstral coefficient */</span>
<a name="l00452"></a>00452     _V = 0040000, <span class="comment">/* has VQ data */</span>
<a name="l00453"></a>00453     _T = 0100000  <span class="comment">/* has third differential coefficients */</span>
<a name="l00454"></a>00454 } htk_feature_flag_t;
<a name="l00455"></a>00455 
<a name="l00459"></a>00459 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00460"></a>00460 output_header_htk(sphinx_wave2feat_t *wtf, int32 nfloat)
<a name="l00461"></a>00461 {
<a name="l00462"></a>00462     int32 samp_period;
<a name="l00463"></a>00463     int16 samp_size;
<a name="l00464"></a>00464     int16 param_kind;
<a name="l00465"></a>00465     <span class="keywordtype">int</span> swap = FALSE;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467     <span class="comment">/* HTK files are big-endian. */</span>
<a name="l00468"></a>00468     <span class="keywordflow">if</span> (0 == strcmp(<span class="stringliteral">"little"</span>, <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-mach_endian"</span>)))
<a name="l00469"></a>00469         swap = TRUE;
<a name="l00470"></a>00470     <span class="comment">/* Same file size thing as in Sphinx files (I think) */</span>
<a name="l00471"></a>00471     <span class="keywordflow">if</span> (swap) SWAP_INT32(&amp;nfloat);
<a name="l00472"></a>00472     <span class="keywordflow">if</span> (fwrite(&amp;nfloat, 4, 1, wtf-&gt;outfh) != 1)
<a name="l00473"></a>00473         <span class="keywordflow">return</span> -1;
<a name="l00474"></a>00474     <span class="comment">/* Sample period in 100ns units. */</span>
<a name="l00475"></a>00475     samp_period = (int32)(1e+7 / cmd_ln_float32_r(wtf-&gt;config, <span class="stringliteral">"-frate"</span>));
<a name="l00476"></a>00476     <span class="keywordflow">if</span> (swap) SWAP_INT32(&amp;samp_period);
<a name="l00477"></a>00477     <span class="keywordflow">if</span> (fwrite(&amp;samp_period, 4, 1, wtf-&gt;outfh) != 1)
<a name="l00478"></a>00478         <span class="keywordflow">return</span> -1;
<a name="l00479"></a>00479     <span class="comment">/* Sample size - veclen * sizeof each sample. */</span>
<a name="l00480"></a>00480     samp_size = wtf-&gt;veclen * 4;
<a name="l00481"></a>00481     <span class="keywordflow">if</span> (swap) SWAP_INT16(&amp;samp_size);
<a name="l00482"></a>00482     <span class="keywordflow">if</span> (fwrite(&amp;samp_size, 2, 1, wtf-&gt;outfh) != 1)
<a name="l00483"></a>00483         <span class="keywordflow">return</span> -1;
<a name="l00484"></a>00484     <span class="comment">/* Format and flags. */</span>
<a name="l00485"></a>00485     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-logspec"</span>)
<a name="l00486"></a>00486         || <a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-cep2spec"</span>))
<a name="l00487"></a>00487         param_kind = FBANK; <span class="comment">/* log mel-filter bank outputs */</span>
<a name="l00488"></a>00488     <span class="keywordflow">else</span>
<a name="l00489"></a>00489         param_kind = MFCC | _O; <span class="comment">/* MFCC + CEP0 (note reordering...) */</span>
<a name="l00490"></a>00490     <span class="keywordflow">if</span> (swap) SWAP_INT16(&amp;param_kind);
<a name="l00491"></a>00491     <span class="keywordflow">if</span> (fwrite(&amp;param_kind, 2, 1, wtf-&gt;outfh) != 1)
<a name="l00492"></a>00492         <span class="keywordflow">return</span> -1;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494     <span class="keywordflow">return</span> 0;
<a name="l00495"></a>00495 }
<a name="l00496"></a>00496 
<a name="l00500"></a>00500 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00501"></a>00501 output_frames_htk(sphinx_wave2feat_t *wtf, mfcc_t **frames, <span class="keywordtype">int</span> nfr)
<a name="l00502"></a>00502 {
<a name="l00503"></a>00503     <span class="keywordtype">int</span> i, j, swap, htk_reorder, nfloat = 0;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505     fe_mfcc_to_float(wtf-&gt;fe, frames, (float32 **)frames, nfr);
<a name="l00506"></a>00506     <span class="comment">/* This is possibly inefficient, but probably not a big deal. */</span>
<a name="l00507"></a>00507     swap = (0 == strcmp(<span class="stringliteral">"little"</span>, <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-mach_endian"</span>)));
<a name="l00508"></a>00508     htk_reorder = (0 == strcmp(<span class="stringliteral">"htk"</span>, wtf-&gt;ot-&gt;name)
<a name="l00509"></a>00509                    &amp;&amp; !(<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-logspec"</span>)
<a name="l00510"></a>00510                         || <a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-cep2spec"</span>)));
<a name="l00511"></a>00511     <span class="keywordflow">for</span> (i = 0; i &lt; nfr; ++i) {
<a name="l00512"></a>00512         <span class="keywordflow">if</span> (htk_reorder) {
<a name="l00513"></a>00513             mfcc_t c0 = frames[i][0];
<a name="l00514"></a>00514             memmove(frames[i] + 1, frames[i], (wtf-&gt;veclen - 1) * 4);
<a name="l00515"></a>00515             frames[i][wtf-&gt;veclen - 1] = c0;
<a name="l00516"></a>00516         }
<a name="l00517"></a>00517         <span class="keywordflow">if</span> (swap)
<a name="l00518"></a>00518             <span class="keywordflow">for</span> (j = 0; j &lt; wtf-&gt;veclen; ++j)
<a name="l00519"></a>00519                 SWAP_FLOAT32(frames[i] + j);
<a name="l00520"></a>00520         <span class="keywordflow">if</span> (fwrite(frames[i], <span class="keyword">sizeof</span>(float32), wtf-&gt;veclen, wtf-&gt;outfh) != wtf-&gt;veclen) {
<a name="l00521"></a>00521             <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Writing %d values to %s failed"</span>,
<a name="l00522"></a>00522                            wtf-&gt;veclen, wtf-&gt;outfile);
<a name="l00523"></a>00523             <span class="keywordflow">return</span> -1;
<a name="l00524"></a>00524         }
<a name="l00525"></a>00525         nfloat += wtf-&gt;veclen;
<a name="l00526"></a>00526     }
<a name="l00527"></a>00527     <span class="keywordflow">return</span> nfloat;
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00533"></a>00533 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00534"></a>00534 output_frames_text(sphinx_wave2feat_t *wtf, mfcc_t **frames, <span class="keywordtype">int</span> nfr)
<a name="l00535"></a>00535 {
<a name="l00536"></a>00536     <span class="keywordtype">int</span> i, j, nfloat = 0;
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     fe_mfcc_to_float(wtf-&gt;fe, frames, (float32 **)frames, nfr);
<a name="l00539"></a>00539     <span class="keywordflow">for</span> (i = 0; i &lt; nfr; ++i) {
<a name="l00540"></a>00540         <span class="keywordflow">for</span> (j = 0; j &lt; wtf-&gt;veclen; ++j) {
<a name="l00541"></a>00541             fprintf(wtf-&gt;outfh, <span class="stringliteral">"%.5g"</span>, frames[i][j]);
<a name="l00542"></a>00542             <span class="keywordflow">if</span> (j == wtf-&gt;veclen - 1)
<a name="l00543"></a>00543                 fprintf(wtf-&gt;outfh, <span class="stringliteral">"\n"</span>);
<a name="l00544"></a>00544             <span class="keywordflow">else</span>
<a name="l00545"></a>00545                 fprintf(wtf-&gt;outfh, <span class="stringliteral">" "</span>);
<a name="l00546"></a>00546         }
<a name="l00547"></a>00547         nfloat += wtf-&gt;veclen;
<a name="l00548"></a>00548     }
<a name="l00549"></a>00549     <span class="keywordflow">return</span> nfloat;
<a name="l00550"></a>00550 }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552 <span class="keyword">static</span> <span class="keyword">const</span> output_type_t outtypes[] = {
<a name="l00553"></a>00553     { <span class="stringliteral">"sphinx"</span>, &amp;output_header_sphinx, &amp;output_frames_sphinx },
<a name="l00554"></a>00554     { <span class="stringliteral">"htk"</span>, &amp;output_header_htk, &amp;output_frames_htk },
<a name="l00555"></a>00555     { <span class="stringliteral">"text"</span>, NULL, &amp;output_frames_text }
<a name="l00556"></a>00556 };
<a name="l00557"></a>00557 <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">int</span> nouttypes = <span class="keyword">sizeof</span>(outtypes)/<span class="keyword">sizeof</span>(outtypes[0]);
<a name="l00558"></a>00558 
<a name="l00559"></a>00559 sphinx_wave2feat_t *
<a name="l00560"></a>00560 sphinx_wave2feat_init(<a class="code" href="structcmd__ln__t.html" title="Opaque structure used to hold the results of command-line parsing.">cmd_ln_t</a> *config)
<a name="l00561"></a>00561 {
<a name="l00562"></a>00562     sphinx_wave2feat_t *wtf;
<a name="l00563"></a>00563     <span class="keywordtype">int</span> i;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565     wtf = <a class="code" href="ckd__alloc_8h.html#a00ef21903bc4f8a972488417adc8d2e" title="Macros to simplify the use of above functions.">ckd_calloc</a>(1, <span class="keyword">sizeof</span>(*wtf));
<a name="l00566"></a>00566     wtf-&gt;refcount = 1;
<a name="l00567"></a>00567     wtf-&gt;config = <a class="code" href="cmd__ln_8h.html#975f5bf7b6f4fc95f426d1979281f73b" title="Retain ownership of a command-line argument set.">cmd_ln_retain</a>(config);
<a name="l00568"></a>00568     wtf-&gt;fe = fe_init_auto_r(wtf-&gt;config);
<a name="l00569"></a>00569     wtf-&gt;ot = outtypes; <span class="comment">/* Default (sphinx) type. */</span>
<a name="l00570"></a>00570     <span class="keywordflow">for</span> (i = 0; i &lt; nouttypes; ++i) {
<a name="l00571"></a>00571         output_type_t <span class="keyword">const</span> *otype = &amp;outtypes[i];
<a name="l00572"></a>00572         <span class="keywordflow">if</span> (0 == strcmp(<a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-ofmt"</span>), otype-&gt;name)) {
<a name="l00573"></a>00573             wtf-&gt;ot = otype;
<a name="l00574"></a>00574             <span class="keywordflow">break</span>;
<a name="l00575"></a>00575         }
<a name="l00576"></a>00576     }
<a name="l00577"></a>00577     <span class="keywordflow">if</span> (i == nouttypes) {
<a name="l00578"></a>00578         <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Unknown output type: '%s'\n"</span>,
<a name="l00579"></a>00579                 <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-ofmt"</span>));
<a name="l00580"></a>00580         sphinx_wave2feat_free(wtf);
<a name="l00581"></a>00581         <span class="keywordflow">return</span> NULL;
<a name="l00582"></a>00582     }
<a name="l00583"></a>00583 
<a name="l00584"></a>00584     <span class="keywordflow">return</span> wtf;
<a name="l00585"></a>00585 }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587 <span class="keywordtype">int</span>
<a name="l00588"></a>00588 sphinx_wave2feat_free(sphinx_wave2feat_t *wtf)
<a name="l00589"></a>00589 {
<a name="l00590"></a>00590     <span class="keywordflow">if</span> (wtf == NULL)
<a name="l00591"></a>00591         <span class="keywordflow">return</span> 0;
<a name="l00592"></a>00592     <span class="keywordflow">if</span> (--wtf-&gt;refcount &gt; 0)
<a name="l00593"></a>00593         <span class="keywordflow">return</span> wtf-&gt;refcount;
<a name="l00594"></a>00594 
<a name="l00595"></a>00595     <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(wtf-&gt;audio);
<a name="l00596"></a>00596     <a class="code" href="ckd__alloc_8h.html#8246c071ac12e98b7e1df9fe6da15aef" title="Free a 2-D array (ptr) previously allocated by ckd_calloc_2d.">ckd_free_2d</a>(wtf-&gt;feat);
<a name="l00597"></a>00597     <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(wtf-&gt;infile);
<a name="l00598"></a>00598     <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(wtf-&gt;outfile);
<a name="l00599"></a>00599     <span class="keywordflow">if</span> (wtf-&gt;infh)
<a name="l00600"></a>00600         fclose(wtf-&gt;infh);
<a name="l00601"></a>00601     <span class="keywordflow">if</span> (wtf-&gt;outfh)
<a name="l00602"></a>00602         fclose(wtf-&gt;outfh);
<a name="l00603"></a>00603     <a class="code" href="cmd__ln_8h.html#26707fc85e87d8999e368a680e7873cd" title="Release a command-line argument set and all associated strings.">cmd_ln_free_r</a>(wtf-&gt;config);
<a name="l00604"></a>00604     fe_free(wtf-&gt;fe);
<a name="l00605"></a>00605     <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(wtf);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607     <span class="keywordflow">return</span> 0;
<a name="l00608"></a>00608 }
<a name="l00609"></a>00609 
<a name="l00610"></a>00610 sphinx_wave2feat_t *
<a name="l00611"></a>00611 sphinx_wave2feat_retain(sphinx_wave2feat_t *wtf)
<a name="l00612"></a>00612 {
<a name="l00613"></a>00613     ++wtf-&gt;refcount;
<a name="l00614"></a>00614     <span class="keywordflow">return</span> wtf;
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a>00617 <span class="keyword">static</span> audio_type_t <span class="keyword">const</span> *
<a name="l00618"></a>00618 detect_audio_type(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *infile)
<a name="l00619"></a>00619 {
<a name="l00620"></a>00620     audio_type_t <span class="keyword">const</span> *atype;
<a name="l00621"></a>00621     <span class="keywordtype">int</span> i;
<a name="l00622"></a>00622 
<a name="l00623"></a>00623     <span class="comment">/* Special case audio type for Sphinx MFCC inputs. */</span>
<a name="l00624"></a>00624     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-spec2cep"</span>)
<a name="l00625"></a>00625         || <a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-cep2spec"</span>)) {
<a name="l00626"></a>00626         <span class="keywordtype">int</span> rv = mfcc_type.detect(wtf, infile);
<a name="l00627"></a>00627         <span class="keywordflow">if</span> (rv == -1)
<a name="l00628"></a>00628             <span class="keywordflow">return</span> NULL;
<a name="l00629"></a>00629         <span class="keywordflow">return</span> &amp;mfcc_type;
<a name="l00630"></a>00630     }
<a name="l00631"></a>00631 
<a name="l00632"></a>00632     <span class="comment">/* Try to use the type of infile given on the command line. */</span>
<a name="l00633"></a>00633     <span class="keywordflow">for</span> (i = 0; i &lt; ntypes; ++i) {
<a name="l00634"></a>00634         <span class="keywordtype">int</span> rv;
<a name="l00635"></a>00635         atype = &amp;types[i];
<a name="l00636"></a>00636         <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, atype-&gt;name)) {
<a name="l00637"></a>00637             rv = (*atype-&gt;detect)(wtf, infile);
<a name="l00638"></a>00638             <span class="keywordflow">if</span> (rv == -1)
<a name="l00639"></a>00639                 <span class="keywordflow">return</span> NULL;
<a name="l00640"></a>00640             <span class="keywordflow">break</span>;
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642     }
<a name="l00643"></a>00643     <span class="keywordflow">if</span> (i == ntypes) {
<a name="l00644"></a>00644         <span class="comment">/* Detect file type of infile and get parameters. */</span>
<a name="l00645"></a>00645         <span class="keywordflow">for</span> (i = 0; i &lt; ntypes; ++i) {
<a name="l00646"></a>00646             <span class="keywordtype">int</span> rv;
<a name="l00647"></a>00647             atype = &amp;types[i];
<a name="l00648"></a>00648             rv = (*atype-&gt;detect)(wtf, infile);
<a name="l00649"></a>00649             <span class="keywordflow">if</span> (rv == -1)
<a name="l00650"></a>00650                 <span class="keywordflow">return</span> NULL;
<a name="l00651"></a>00651             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rv == TRUE)
<a name="l00652"></a>00652             <span class="keywordflow">break</span>;
<a name="l00653"></a>00653         }
<a name="l00654"></a>00654         <span class="keywordflow">if</span> (i == ntypes)
<a name="l00655"></a>00655             atype = NULL;
<a name="l00656"></a>00656     }
<a name="l00657"></a>00657     <span class="keywordflow">return</span> atype;
<a name="l00658"></a>00658 }
<a name="l00659"></a>00659 
<a name="l00660"></a>00660 <span class="keywordtype">int</span>
<a name="l00661"></a>00661 sphinx_wave2feat_convert_file(sphinx_wave2feat_t *wtf,
<a name="l00662"></a>00662                               <span class="keywordtype">char</span> <span class="keyword">const</span> *infile, <span class="keywordtype">char</span> <span class="keyword">const</span> *outfile)
<a name="l00663"></a>00663 {
<a name="l00664"></a>00664     <span class="keywordtype">int</span> minfft, nfft, nfloat, veclen;
<a name="l00665"></a>00665     audio_type_t <span class="keyword">const</span> *atype;
<a name="l00666"></a>00666     <span class="keywordtype">int</span> fshift, fsize;
<a name="l00667"></a>00667 
<a name="l00668"></a>00668     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(wtf-&gt;config, <span class="stringliteral">"-verbose"</span>))
<a name="l00669"></a>00669         <a class="code" href="err_8h.html#c3c705943d946708cea0a1443be1c853" title="Print logging information to standard error stream.">E_INFO</a>(<span class="stringliteral">"Converting %s to %s\n"</span>, infile, outfile);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671     <span class="comment">/* Detect input file type. */</span>
<a name="l00672"></a>00672     <span class="keywordflow">if</span> ((atype = detect_audio_type(wtf, infile)) == NULL)
<a name="l00673"></a>00673         <span class="keywordflow">return</span> -1;
<a name="l00674"></a>00674 
<a name="l00675"></a>00675     <span class="comment">/* Determine whether to byteswap input. */</span>
<a name="l00676"></a>00676     wtf-&gt;byteswap = strcmp(<a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-mach_endian"</span>),
<a name="l00677"></a>00677                            <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(wtf-&gt;config, <span class="stringliteral">"-input_endian"</span>));
<a name="l00678"></a>00678 
<a name="l00679"></a>00679     <span class="comment">/* Make sure the FFT size is sufficiently large. */</span>
<a name="l00680"></a>00680     minfft = (int)(cmd_ln_float32_r(wtf-&gt;config, <span class="stringliteral">"-samprate"</span>)
<a name="l00681"></a>00681                    * cmd_ln_float32_r(wtf-&gt;config, <span class="stringliteral">"-wlen"</span>) + 0.5);
<a name="l00682"></a>00682     <span class="keywordflow">for</span> (nfft = 1; nfft &lt; minfft; nfft &lt;&lt;= 1)
<a name="l00683"></a>00683         ;
<a name="l00684"></a>00684     <span class="keywordflow">if</span> (nfft &gt; cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-nfft"</span>)) {
<a name="l00685"></a>00685         <a class="code" href="err_8h.html#6a794bec721b555ac1f2167f9e12f662" title="Print warning information to standard error stream.">E_WARN</a>(<span class="stringliteral">"Value of -nfft = %d is too small, increasing to %d\n"</span>,
<a name="l00686"></a>00686                cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-nfft"</span>), nfft);
<a name="l00687"></a>00687         cmd_ln_set_int32_r(wtf-&gt;config, <span class="stringliteral">"-nfft"</span>, nfft);
<a name="l00688"></a>00688         fe_free(wtf-&gt;fe);
<a name="l00689"></a>00689         wtf-&gt;fe = fe_init_auto_r(wtf-&gt;config);
<a name="l00690"></a>00690     }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692     <span class="comment">/* Get the output frame size (if not already set). */</span>
<a name="l00693"></a>00693     <span class="keywordflow">if</span> (wtf-&gt;veclen == 0)
<a name="l00694"></a>00694         wtf-&gt;veclen = fe_get_output_size(wtf-&gt;fe);
<a name="l00695"></a>00695 
<a name="l00696"></a>00696     <span class="comment">/* Set up the input and output buffers. */</span>
<a name="l00697"></a>00697     fe_get_input_size(wtf-&gt;fe, &amp;fshift, &amp;fsize);
<a name="l00698"></a>00698     <span class="comment">/* Want to get at least a whole frame plus shift in here. */</span>
<a name="l00699"></a>00699     wtf-&gt;blocksize = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-blocksize"</span>);
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (wtf-&gt;blocksize &lt; fsize + fshift) {
<a name="l00701"></a>00701         <a class="code" href="err_8h.html#c3c705943d946708cea0a1443be1c853" title="Print logging information to standard error stream.">E_INFO</a>(<span class="stringliteral">"Block size of %d too small, increasing to %d\n"</span>,
<a name="l00702"></a>00702                wtf-&gt;blocksize, fsize + fshift);
<a name="l00703"></a>00703         wtf-&gt;blocksize = fsize + fshift;
<a name="l00704"></a>00704     }
<a name="l00705"></a>00705     wtf-&gt;audio = <a class="code" href="ckd__alloc_8h.html#a00ef21903bc4f8a972488417adc8d2e" title="Macros to simplify the use of above functions.">ckd_calloc</a>(wtf-&gt;blocksize, <span class="keyword">sizeof</span>(*wtf-&gt;audio));
<a name="l00706"></a>00706     wtf-&gt;featsize = (wtf-&gt;blocksize - fsize) / fshift;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708     <span class="comment">/* Use the maximum of the input and output frame sizes to allocate this. */</span>
<a name="l00709"></a>00709     veclen = wtf-&gt;veclen;
<a name="l00710"></a>00710     <span class="keywordflow">if</span> (wtf-&gt;in_veclen &gt; veclen) veclen = wtf-&gt;in_veclen;
<a name="l00711"></a>00711     wtf-&gt;feat = <a class="code" href="ckd__alloc_8h.html#949e7b50fcd9697b1563fa57f50e9c4f" title="Macro for __ckd_calloc_2d__.">ckd_calloc_2d</a>(wtf-&gt;featsize, veclen, <span class="keyword">sizeof</span>(**wtf-&gt;feat));
<a name="l00712"></a>00712 
<a name="l00713"></a>00713     <span class="comment">/* Let's go! */</span>
<a name="l00714"></a>00714     <span class="keywordflow">if</span> ((wtf-&gt;outfh = fopen(outfile, <span class="stringliteral">"wb"</span>)) == NULL) {
<a name="l00715"></a>00715         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open %s for writing"</span>, outfile);
<a name="l00716"></a>00716         <span class="keywordflow">return</span> -1;
<a name="l00717"></a>00717     }
<a name="l00718"></a>00718     <span class="comment">/* Write an empty header, which we'll fill in later. */</span>
<a name="l00719"></a>00719     <span class="keywordflow">if</span> (wtf-&gt;ot-&gt;output_header &amp;&amp;
<a name="l00720"></a>00720         (*wtf-&gt;ot-&gt;output_header)(wtf, 0) &lt; 0) {
<a name="l00721"></a>00721         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to write empty header to %s\n"</span>, outfile);
<a name="l00722"></a>00722         <span class="keywordflow">goto</span> error_out;
<a name="l00723"></a>00723     }
<a name="l00724"></a>00724     wtf-&gt;outfile = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(outfile);
<a name="l00725"></a>00725 
<a name="l00726"></a>00726     <span class="keywordflow">if</span> ((nfloat = (*atype-&gt;decode)(wtf)) &lt; 0)
<a name="l00727"></a>00727         <span class="keywordflow">return</span> -1;
<a name="l00728"></a>00728 
<a name="l00729"></a>00729     <span class="keywordflow">if</span> (wtf-&gt;ot-&gt;output_header) {
<a name="l00730"></a>00730         <span class="keywordflow">if</span> (fseek(wtf-&gt;outfh, 0, SEEK_SET) &lt; 0) {
<a name="l00731"></a>00731             <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to seek to beginning of %s\n"</span>, outfile);
<a name="l00732"></a>00732             <span class="keywordflow">goto</span> error_out;
<a name="l00733"></a>00733         }
<a name="l00734"></a>00734         <span class="keywordflow">if</span> ((*wtf-&gt;ot-&gt;output_header)(wtf, nfloat) &lt; 0) {
<a name="l00735"></a>00735             <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to write header to %s\n"</span>, outfile);
<a name="l00736"></a>00736             <span class="keywordflow">goto</span> error_out;
<a name="l00737"></a>00737         }
<a name="l00738"></a>00738     }
<a name="l00739"></a>00739     fclose(wtf-&gt;outfh);
<a name="l00740"></a>00740     wtf-&gt;outfh = NULL;
<a name="l00741"></a>00741 
<a name="l00742"></a>00742     <span class="keywordflow">return</span> 0;
<a name="l00743"></a>00743 error_out:
<a name="l00744"></a>00744     <span class="keywordflow">if</span> (wtf-&gt;outfh) {
<a name="l00745"></a>00745         fclose(wtf-&gt;outfh);
<a name="l00746"></a>00746         wtf-&gt;outfh = NULL;
<a name="l00747"></a>00747     }
<a name="l00748"></a>00748     <span class="keywordflow">return</span> -1;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 
<a name="l00751"></a>00751 <span class="keywordtype">void</span>
<a name="l00752"></a>00752 build_filenames(<a class="code" href="structcmd__ln__t.html" title="Opaque structure used to hold the results of command-line parsing.">cmd_ln_t</a> *config, <span class="keywordtype">char</span> <span class="keyword">const</span> *basename,
<a name="l00753"></a>00753                 <span class="keywordtype">char</span> **out_infile, <span class="keywordtype">char</span> **out_outfile)
<a name="l00754"></a>00754 {
<a name="l00755"></a>00755     <span class="keywordtype">char</span> <span class="keyword">const</span> *di, *do_, *ei, *eo;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757     di = <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-di"</span>);
<a name="l00758"></a>00758     do_ = <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-do"</span>);
<a name="l00759"></a>00759     ei = <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-ei"</span>);
<a name="l00760"></a>00760     eo = <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-eo"</span>);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762     *out_infile = <a class="code" href="strfuncs_8h.html#317522f23d291311e366de34ef86b777" title="Concatenate a NULL-terminated argument list of strings, returning a newly allocated...">string_join</a>(di ? di : <span class="stringliteral">""</span>,
<a name="l00763"></a>00763                               di ? <span class="stringliteral">"/"</span> : <span class="stringliteral">""</span>,
<a name="l00764"></a>00764                               basename,
<a name="l00765"></a>00765                               ei ? <span class="stringliteral">"."</span> : <span class="stringliteral">""</span>,
<a name="l00766"></a>00766                               ei ? ei : <span class="stringliteral">""</span>,
<a name="l00767"></a>00767                               NULL);
<a name="l00768"></a>00768     *out_outfile = <a class="code" href="strfuncs_8h.html#317522f23d291311e366de34ef86b777" title="Concatenate a NULL-terminated argument list of strings, returning a newly allocated...">string_join</a>(do_ ? do_ : <span class="stringliteral">""</span>,
<a name="l00769"></a>00769                                do_ ? <span class="stringliteral">"/"</span> : <span class="stringliteral">""</span>,
<a name="l00770"></a>00770                                basename,
<a name="l00771"></a>00771                                eo ? <span class="stringliteral">"."</span> : <span class="stringliteral">""</span>,
<a name="l00772"></a>00772                                eo ? eo : <span class="stringliteral">""</span>,
<a name="l00773"></a>00773                               NULL);
<a name="l00774"></a>00774     <span class="comment">/* Build output directory structure if possible/requested (it is</span>
<a name="l00775"></a>00775 <span class="comment">     * by default). */</span>
<a name="l00776"></a>00776     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#159e691c95089689cf9a8f85a67830a6" title="Retrieve a boolean value from a command-line object.">cmd_ln_boolean_r</a>(config, <span class="stringliteral">"-build_outdirs"</span>)) {
<a name="l00777"></a>00777         <span class="keywordtype">char</span> *dirname = <a class="code" href="ckd__alloc_8h.html#d313f92478859f9e4ea99d0f6e78c393" title="Macro for __ckd_salloc__.">ckd_salloc</a>(*out_outfile);
<a name="l00778"></a>00778         <a class="code" href="filename_8h.html#678be92ddb74695f26a9e4f527b073b0" title="Strip off filename from the given path and copy the directory name into dir Caller...">path2dirname</a>(*out_outfile, dirname);
<a name="l00779"></a>00779         <a class="code" href="pio_8h.html#6df697b8a08cd4d11fe7b864dcb99012" title="Create a directory and all of its parent directories, as needed.">build_directory</a>(dirname);
<a name="l00780"></a>00780         <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(dirname);
<a name="l00781"></a>00781     }
<a name="l00782"></a>00782 }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="keyword">static</span> <span class="keywordtype">int</span>
<a name="l00785"></a>00785 run_control_file(sphinx_wave2feat_t *wtf, <span class="keywordtype">char</span> <span class="keyword">const</span> *ctlfile)
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787     <a class="code" href="structlineiter__t.html" title="Line iterator for files.">lineiter_t</a> *li;
<a name="l00788"></a>00788     FILE *ctlfh;
<a name="l00789"></a>00789     <span class="keywordtype">int</span> nskip, runlen, npart;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791     <span class="keywordflow">if</span> ((ctlfh = fopen(ctlfile, <span class="stringliteral">"r"</span>)) == NULL) {
<a name="l00792"></a>00792         <a class="code" href="err_8h.html#54ffbfe898d74595c586a1f48f32ef03" title="Print error text; Call perror(&amp;quot;&amp;quot;);.">E_ERROR_SYSTEM</a>(<span class="stringliteral">"Failed to open control file %s"</span>, ctlfile);
<a name="l00793"></a>00793         <span class="keywordflow">return</span> -1;
<a name="l00794"></a>00794     }
<a name="l00795"></a>00795     nskip = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-nskip"</span>);
<a name="l00796"></a>00796     runlen = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-runlen"</span>);
<a name="l00797"></a>00797     <span class="keywordflow">if</span> ((npart = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-npart"</span>))) {
<a name="l00798"></a>00798         <span class="comment">/* Count lines in the file. */</span>
<a name="l00799"></a>00799         <span class="keywordtype">int</span> nlines, partlen, part;
<a name="l00800"></a>00800         part = cmd_ln_int32_r(wtf-&gt;config, <span class="stringliteral">"-part"</span>);
<a name="l00801"></a>00801         <span class="keywordflow">for</span> (nlines = 0, li = <a class="code" href="pio_8h.html#22d0125ab198f02f8bbe543417d99566" title="Start reading lines from a file.">lineiter_start</a>(ctlfh); li; li = <a class="code" href="pio_8h.html#ff8df0b6928746d61b3520555263f71e" title="Move to the next line in the file.">lineiter_next</a>(li))
<a name="l00802"></a>00802             ++nlines;
<a name="l00803"></a>00803         fseek(ctlfh, 0, SEEK_SET);
<a name="l00804"></a>00804         partlen = nlines / npart;
<a name="l00805"></a>00805         nskip = partlen * (part - 1);
<a name="l00806"></a>00806         <span class="keywordflow">if</span> (part == npart)
<a name="l00807"></a>00807             runlen = -1;
<a name="l00808"></a>00808         <span class="keywordflow">else</span>
<a name="l00809"></a>00809             runlen = partlen;
<a name="l00810"></a>00810     }
<a name="l00811"></a>00811     <span class="keywordflow">if</span> (runlen != -1)
<a name="l00812"></a>00812         <a class="code" href="err_8h.html#c3c705943d946708cea0a1443be1c853" title="Print logging information to standard error stream.">E_INFO</a>(<span class="stringliteral">"Processing %d utterances at position %d\n"</span>, runlen, nskip);
<a name="l00813"></a>00813     <span class="keywordflow">else</span>
<a name="l00814"></a>00814         <a class="code" href="err_8h.html#c3c705943d946708cea0a1443be1c853" title="Print logging information to standard error stream.">E_INFO</a>(<span class="stringliteral">"Processing all remaining utterances at position %d\n"</span>, nskip);
<a name="l00815"></a>00815     <span class="keywordflow">for</span> (li = <a class="code" href="pio_8h.html#22d0125ab198f02f8bbe543417d99566" title="Start reading lines from a file.">lineiter_start</a>(ctlfh); li; li = <a class="code" href="pio_8h.html#ff8df0b6928746d61b3520555263f71e" title="Move to the next line in the file.">lineiter_next</a>(li)) {
<a name="l00816"></a>00816         <span class="keywordtype">char</span> *infile, *outfile;
<a name="l00817"></a>00817         <span class="keywordtype">int</span> rv;
<a name="l00818"></a>00818 
<a name="l00819"></a>00819         <span class="keywordflow">if</span> (nskip-- &gt; 0)
<a name="l00820"></a>00820             <span class="keywordflow">continue</span>;
<a name="l00821"></a>00821         <span class="keywordflow">if</span> (runlen == 0)
<a name="l00822"></a>00822             <span class="keywordflow">break</span>;
<a name="l00823"></a>00823         --runlen;
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         <a class="code" href="strfuncs_8h.html#c36a095632a4f16cf4e0fbcdb01de5ad" title="Remove whitespace from a string, modifying it in-place.">string_trim</a>(li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>, <a class="code" href="strfuncs_8h.html#b5c9ca15770a4bd3047705762b815df94fcbb0fe16fa4aa48723ba3ba10c26dd" title="Both ends of string.">STRING_BOTH</a>);
<a name="l00826"></a>00826         build_filenames(wtf-&gt;config, li-&gt;<a class="code" href="structlineiter__t.html#1bf482b3c2722af76102f7b4aae08e47">buf</a>, &amp;infile, &amp;outfile);
<a name="l00827"></a>00827         rv = sphinx_wave2feat_convert_file(wtf, infile, outfile);
<a name="l00828"></a>00828         <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(infile);
<a name="l00829"></a>00829         <a class="code" href="ckd__alloc_8h.html#31c6b405558620ac37599737b5722fbf" title="Test and free a 1-D array.">ckd_free</a>(outfile);
<a name="l00830"></a>00830         <span class="keywordflow">if</span> (rv != 0) {
<a name="l00831"></a>00831             <a class="code" href="pio_8h.html#3f80e5d4d666426cef229dd41237d9cf" title="Stop reading lines from a file.">lineiter_free</a>(li);
<a name="l00832"></a>00832             fclose(ctlfh);
<a name="l00833"></a>00833             <span class="keywordflow">return</span> rv;
<a name="l00834"></a>00834         }
<a name="l00835"></a>00835     }
<a name="l00836"></a>00836     <span class="keywordflow">return</span> 0;
<a name="l00837"></a>00837 }
<a name="l00838"></a>00838 
<a name="l00839"></a>00839 <span class="keywordtype">int</span>
<a name="l00840"></a>00840 main(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842     sphinx_wave2feat_t *wtf;
<a name="l00843"></a>00843     <a class="code" href="structcmd__ln__t.html" title="Opaque structure used to hold the results of command-line parsing.">cmd_ln_t</a> *config;
<a name="l00844"></a>00844     <span class="keywordtype">int</span> rv;
<a name="l00845"></a>00845 
<a name="l00846"></a>00846     <span class="comment">/* Initialize config. */</span>
<a name="l00847"></a>00847     <span class="keywordflow">if</span> ((config = <a class="code" href="cmd__ln_8h.html#a5a3a9e49198d8fd0dd3424fb880b6b6" title="Parse a list of strings into argumetns.">cmd_ln_parse_r</a>(NULL, defn, argc, argv, TRUE)) == NULL)
<a name="l00848"></a>00848         <span class="keywordflow">return</span> 2;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850     <span class="comment">/* Parse an argument file if there's one in there. */</span>
<a name="l00851"></a>00851     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-argfile"</span>))
<a name="l00852"></a>00852         config = <a class="code" href="cmd__ln_8h.html#57f54649952a07b8bef888af4e416550" title="Parse an arguments file by deliminating on &amp;quot; \r\t\n&amp;quot; and putting each tokens...">cmd_ln_parse_file_r</a>(config, defn,
<a name="l00853"></a>00853                                      <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-argfile"</span>), FALSE);
<a name="l00854"></a>00854     <span class="keywordflow">if</span> (config == NULL) {
<a name="l00855"></a>00855         <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Command line parsing failed\n"</span>);
<a name="l00856"></a>00856         <span class="keywordflow">return</span> 1;
<a name="l00857"></a>00857     }
<a name="l00858"></a>00858     <span class="keywordflow">if</span> ((wtf = sphinx_wave2feat_init(config)) == NULL) {
<a name="l00859"></a>00859         <a class="code" href="err_8h.html#5f7b2f58f5a663a6bdd51f197ae21993" title="Print error message to standard error stream.">E_ERROR</a>(<span class="stringliteral">"Failed to initialize wave2feat object\n"</span>);
<a name="l00860"></a>00860         <span class="keywordflow">return</span> 1;
<a name="l00861"></a>00861     }
<a name="l00862"></a>00862 
<a name="l00863"></a>00863     <span class="comment">/* If there's a control file run through it, otherwise we will do</span>
<a name="l00864"></a>00864 <span class="comment">     * a single file (which is what run_control_file will do</span>
<a name="l00865"></a>00865 <span class="comment">     * internally too) */</span>
<a name="l00866"></a>00866     <span class="keywordflow">if</span> (<a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-c"</span>))
<a name="l00867"></a>00867         rv = run_control_file(wtf, <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-c"</span>));
<a name="l00868"></a>00868     <span class="keywordflow">else</span>
<a name="l00869"></a>00869         rv = sphinx_wave2feat_convert_file(wtf, <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-i"</span>),
<a name="l00870"></a>00870                                            <a class="code" href="cmd__ln_8h.html#f0aa15288e06fc8271298e4fa7cdc91a" title="Retrieve a string from a command-line object.">cmd_ln_str_r</a>(config, <span class="stringliteral">"-o"</span>));
<a name="l00871"></a>00871 
<a name="l00872"></a>00872     sphinx_wave2feat_free(wtf);
<a name="l00873"></a>00873     <span class="keywordflow">return</span> rv;
<a name="l00874"></a>00874 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Sat Dec 3 20:28:37 2011 for SphinxBase by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.7.1 </small></address>
</body>
</html>
